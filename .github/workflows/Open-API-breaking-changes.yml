on: [pull_request]

name: validate-OpenAPI-changes
jobs:
  detect-breaking-changes: 
    runs-on: ubuntu-latest
    steps: 
    - name: Check out HEAD revision
      uses: actions/checkout@v2
      with:
        ref: ${{ github.head_ref }}
        path: head
    - name: Check out BASE revision
      uses: actions/checkout@v2
      with:
        ref: ${{ github.base_ref }}
        path: base   
    - name: Run OpenAPI Diff (from HEAD revision)
      uses: docker://openapitools/openapi-diff:latest
      with:
        args: head/schemas/api.github.com.yaml base/schemas/api.github.com.yaml --text results.txt
    - name: Create results comment for the PR
      id: comment
      run: echo ::set-output name=results::$(cat results.txt | while read i; do echo $i\<br\>; done)
    - name: Write context
      run: echo github.context
    - name: Add results comment on PR 
      uses: actions/github-script@47f7cf65b5ced0830a325f705cad64f2f58dddf7
      if: steps.comment.outputs.results != null && github.event_name == 'pull_request'
      env:
        COMMENT: ${{ steps.comment.outputs.results }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
          github.issues.createComment({ issue_number, owner, repo, body: process.env.COMMENT });
    - name: Run OpenAPI Diff (get state)
      # This is fragile - the alternative is to run validation again with --state and validate that result
      if: "contains(steps.comment.outputs.results, 'API changes broke backward compatibility')"
      run: exit 1
  

